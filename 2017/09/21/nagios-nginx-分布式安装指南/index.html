<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Vic7or,455036517@qq.com"><title>nagios+nginx+分布式安装指南 · Forever Young</title><meta name="description" content="nagios配置监控##监控主机安装

安装nginx支持

安装perl
1yum install perl

安装FCGI模块
12345678910wget http://search.cpan.org/CPAN/authors/id/F/FL/FLORA/FCGI-0.73.tar.gzta"><meta name="keywords" content="Hexo,java,php,html.Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Forever Young</a></h3><div class="description"><p>Nothing lasts forever.</p></div></div></div><ul class="social-links"><li><a href="http://github.com/https://github.com/mzenm"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>nagios+nginx+分布式安装指南</a></h3></div><div class="post-content"><h1 id="nagios配置监控"><a href="#nagios配置监控" class="headerlink" title="nagios配置监控"></a>nagios配置监控</h1><p>##监控主机安装</p>
<ul>
<li><p>安装nginx支持</p>
<ol>
<li><p>安装perl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install perl</div></pre></td></tr></table></figure>
</li>
<li><p>安装FCGI模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">wget http://search.cpan.org/CPAN/authors/id/F/FL/FLORA/FCGI-0.73.tar.gz</div><div class="line">tar xvzf FCGI-0.73.tar.gz </div><div class="line">cd FCGI-0.73</div><div class="line">perl Makefile.PL</div><div class="line">make</div><div class="line">make install</div><div class="line">cd .. </div><div class="line"><span class="meta"></span></div><div class="line">#如果出现Can't locate ExtUtils/MakeMaker.pm in @INC，先执行以下任务</div><div class="line"> yum install perl-ExtUtils-Embed -y</div></pre></td></tr></table></figure>
</li>
<li><p>安装FCGI-ProcManager模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wget http://search.cpan.org/CPAN/authors/id/G/GB/GBJK/FCGI-ProcManager-0.19.tar.gz</div><div class="line">tar xvzf FCGI-ProcManager-0.19.tar.gz </div><div class="line">cd FCGI-ProcManager-0.19</div><div class="line">perl Makefile.PL </div><div class="line">make</div><div class="line">make install</div><div class="line">cd ..</div></pre></td></tr></table></figure>
</li>
<li><p>安装IO和IO::ALL模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">wget http://search.cpan.org/CPAN/authors/id/G/GB/GBARR/IO-1.25.tar.gz</div><div class="line">tar zxvf IO-1.25.tar.gz</div><div class="line">cd IO-1.25</div><div class="line">perl Makefile.PL</div><div class="line">make</div><div class="line">make install</div><div class="line">cd ..</div><div class="line"></div><div class="line">wget https://cpan.metacpan.org/authors/id/F/FR/FREW/IO-All-0.87.tar.gz</div><div class="line">tar zxvf IO-All-0.87.tar.gz</div><div class="line">cd IO-All-0.87</div><div class="line">perl Makefile.PL</div><div class="line">make</div><div class="line">make install</div><div class="line">cd ..</div></pre></td></tr></table></figure>
</li>
<li><p>创建perl-fcgi脚本并给予权限</p>
<p>fastcgi自启动服务脚本：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line">文件路径：/etc/rc.d/init.d/perl-fastcgi</div><div class="line"> </div><div class="line"><span class="comment">#!/bin/sh</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># nginx – this script starts and stops the nginx daemon</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># chkconfig: - 85 15</span></div><div class="line"><span class="comment"># description: Nginx is an HTTP(S) server, HTTP(S) reverse \</span></div><div class="line"><span class="comment"># proxy and IMAP/POP3 proxy server</span></div><div class="line"><span class="comment"># processname: nginx</span></div><div class="line"><span class="comment"># config: /opt/nginx/conf/nginx.conf</span></div><div class="line"><span class="comment"># pidfile: /opt/nginx/logs/nginx.pid</span></div><div class="line"> </div><div class="line"><span class="comment"># Source function library.</span></div><div class="line">. /etc/rc.d/init.d/functions</div><div class="line"> </div><div class="line"><span class="comment"># Source networking configuration.</span></div><div class="line">. /etc/sysconfig/network</div><div class="line"> </div><div class="line"><span class="comment"># Check that networking is up.</span></div><div class="line">[ <span class="string">"$NETWORKING"</span> = <span class="string">"no"</span> ] &amp;&amp; <span class="keyword">exit</span> <span class="number">0</span></div><div class="line"> </div><div class="line">perlfastcgi=<span class="string">"/usr/bin/fastcgi-wrapper.pl"</span></div><div class="line">prog=$(basename perl)</div><div class="line"> </div><div class="line">lockfile=<span class="regexp">/var/lock</span><span class="regexp">/subsys/perl</span>-fastcgi</div><div class="line"> </div><div class="line">start() &#123;</div><div class="line">    [ -<span class="keyword">x</span> $perlfastcgi ] || <span class="keyword">exit</span> <span class="number">5</span></div><div class="line">    echo -n $"Starting $prog: <span class="string">"</span></div><div class="line">    daemon $perlfastcgi</div><div class="line">    retval=$?</div><div class="line">    echo</div><div class="line">    [ $retval -eq 0 ] &amp;&amp; touch $lockfile</div><div class="line">    return $retval</div><div class="line">&#125;</div><div class="line"> </div><div class="line">stop() &#123;</div><div class="line">    echo -n $"Stopping $prog: "</div><div class="line">    killproc $prog -QUIT</div><div class="line">    retval=$?</div><div class="line">    echo</div><div class="line">    [ $retval -eq <span class="number">0</span> ] &amp;&amp; rm -f $lockfile</div><div class="line">    <span class="keyword">return</span> $retval</div><div class="line">&#125;</div><div class="line"> </div><div class="line">restart() &#123;</div><div class="line">    stop</div><div class="line">    start</div><div class="line">&#125;</div><div class="line"> </div><div class="line">reload() &#123;</div><div class="line">    echo -n $”Reloading $prog: ”</div><div class="line">    killproc $nginx -HUP</div><div class="line">    RETVAL=$?</div><div class="line">    echo</div><div class="line">&#125;</div><div class="line"> </div><div class="line">force_reload() &#123;</div><div class="line">    restart</div><div class="line">&#125;</div><div class="line">rh_status() &#123;</div><div class="line">    status $prog</div><div class="line">&#125;</div><div class="line"> </div><div class="line">rh_status_<span class="string">q()</span> &#123;</div><div class="line">    rh_status &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line">case <span class="string">"$1"</span> in</div><div class="line">    start)</div><div class="line">        rh_status_q &amp;&amp; <span class="keyword">exit</span> <span class="number">0</span></div><div class="line">        $1</div><div class="line">        ;;</div><div class="line">    stop)</div><div class="line">        rh_status_<span class="string">q ||</span> <span class="keyword">exit</span> <span class="number">0</span></div><div class="line">        $1</div><div class="line">        ;;</div><div class="line">    restart)</div><div class="line">        $1</div><div class="line">        ;;</div><div class="line">    reload)</div><div class="line">        rh_status_<span class="string">q ||</span> <span class="keyword">exit</span> <span class="number">7</span></div><div class="line">        $1</div><div class="line">        ;;</div><div class="line">    force-reload)</div><div class="line">        force_reload</div><div class="line">        ;;</div><div class="line">    status)</div><div class="line">        rh_status</div><div class="line">        ;;</div><div class="line">    condrestart|try-restart)</div><div class="line">        rh_status_<span class="string">q ||</span> <span class="keyword">exit</span> <span class="number">0</span></div><div class="line">        ;;</div><div class="line">    *)</div><div class="line">        echo $"Usage: $0 &#123;start|stop|status|restart|condrestart|try-restart|reload|force-reload&#125;<span class="string">"</span></div><div class="line">        exit 2</div><div class="line">    esac</div></pre></td></tr></table></figure>
<p>​</p>
<p>fastcgi监听脚本</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line">文件路径：/usr/bin/fastcgi-wrapper.pl</div><div class="line"></div><div class="line"><span class="comment">#!/usr/bin/perl</span></div><div class="line"> </div><div class="line"><span class="keyword">use</span> FCGI;</div><div class="line"><span class="keyword">use</span> Socket;</div><div class="line"><span class="keyword">use</span> POSIX <span class="string">qw(setsid)</span>;</div><div class="line"> </div><div class="line"><span class="keyword">require</span> <span class="string">'syscall.ph'</span>;</div><div class="line"> </div><div class="line">&amp;daemonize;</div><div class="line"> </div><div class="line"><span class="comment">#this keeps the program alive or something after exec'ing perl scripts</span></div><div class="line">END() &#123; &#125; BEGIN() &#123; &#125;</div><div class="line">*CORE::GLOBAL::<span class="keyword">exit</span> = <span class="function"><span class="keyword">sub</span> </span>&#123; <span class="keyword">die</span> <span class="string">"fakeexit\nrc="</span>.shift().<span class="string">"\n"</span>; &#125;;</div><div class="line"><span class="keyword">eval</span> <span class="string">q&#123;exit&#125;</span>;</div><div class="line"><span class="keyword">if</span> ($@) &#123;</div><div class="line">    <span class="keyword">exit</span> <span class="keyword">unless</span> $@ =~ <span class="regexp">/^fakeexit/</span>;</div><div class="line">&#125;;</div><div class="line"> </div><div class="line">&amp;main;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">daemonize</span>() </span>&#123;</div><div class="line">    <span class="keyword">chdir</span> <span class="string">'/'</span>                 <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't chdir to /: $!"</span>;</div><div class="line">    <span class="keyword">defined</span>(<span class="keyword">my</span> $pid = <span class="keyword">fork</span>)   <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't fork: $!"</span>;</div><div class="line">    <span class="keyword">exit</span> <span class="keyword">if</span> $pid;</div><div class="line">    setsid                    <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't start a new session: $!"</span>;</div><div class="line">    <span class="keyword">umask</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</div><div class="line">        $socket = FCGI::OpenSocket( <span class="string">"127.0.0.1:8999"</span>, <span class="number">10</span> ); <span class="comment">#use IP sockets</span></div><div class="line">        $request = FCGI::Request( \*STDIN, \*STDOUT, \*STDERR, \%req_params, $socket );</div><div class="line">        <span class="keyword">if</span> ($request) &#123; request_loop()&#125;;</div><div class="line">            FCGI::CloseSocket( $socket );</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">request_loop</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span>( $request-&gt;Accept() &gt;= <span class="number">0</span> ) &#123;</div><div class="line"> </div><div class="line">           <span class="comment">#processing any STDIN input from WebServer (for CGI-POST actions)</span></div><div class="line">           $stdin_passthrough =<span class="string">''</span>;</div><div class="line">           $req_len = <span class="number">0</span> + $req_params&#123;<span class="string">'CONTENT_LENGTH'</span>&#125;;</div><div class="line">           <span class="keyword">if</span> (($req_params&#123;<span class="string">'REQUEST_METHOD'</span>&#125; eq <span class="string">'POST'</span>) &amp;&amp; ($req_len != <span class="number">0</span>) )&#123;</div><div class="line">                <span class="keyword">my</span> $bytes_read = <span class="number">0</span>;</div><div class="line">                <span class="keyword">while</span> ($bytes_read &lt; $req_len) &#123;</div><div class="line">                        <span class="keyword">my</span> $data = <span class="string">''</span>;</div><div class="line">                        <span class="keyword">my</span> $bytes = <span class="keyword">read</span>(STDIN, $data, ($req_len - $bytes_read));</div><div class="line">                        <span class="keyword">last</span> <span class="keyword">if</span> ($bytes == <span class="number">0</span> || !<span class="keyword">defined</span>($bytes));</div><div class="line">                        $stdin_passthrough .= $data;</div><div class="line">                        $bytes_read += $bytes;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="comment">#running the cgi app</span></div><div class="line">            <span class="keyword">if</span> ( (-<span class="keyword">x</span> $req_params<span class="string">&#123;SCRIPT_FILENAME&#125;</span>) &amp;&amp;  <span class="comment">#can I execute this?</span></div><div class="line">                 (-<span class="keyword">s</span> $req_params<span class="string">&#123;SCRIPT_FILENAME&#125;</span>) &amp;&amp;  <span class="comment">#Is this file empty?</span></div><div class="line">                 (-r $req_params<span class="string">&#123;SCRIPT_FILENAME&#125;</span>)     <span class="comment">#can I read this file?</span></div><div class="line">            )&#123;</div><div class="line">        <span class="keyword">pipe</span>(CHILD_RD, PARENT_WR);</div><div class="line">        <span class="keyword">my</span> $pid = <span class="keyword">open</span>(KID_TO_READ, <span class="string">"-|"</span>);</div><div class="line">        <span class="keyword">unless</span>(<span class="keyword">defined</span>($pid)) &#123;</div><div class="line">            <span class="keyword">print</span>(<span class="string">"Content-type: text/plain\r\n\r\n"</span>);</div><div class="line">                        <span class="keyword">print</span> <span class="string">"Error: CGI app returned no output - "</span>;</div><div class="line">                        <span class="keyword">print</span> <span class="string">"Executing $req_params&#123;SCRIPT_FILENAME&#125; failed !\n"</span>;</div><div class="line">            <span class="keyword">next</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ($pid &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">close</span>(CHILD_RD);</div><div class="line">            <span class="keyword">print</span> PARENT_WR $stdin_passthrough;</div><div class="line">            <span class="keyword">close</span>(PARENT_WR);</div><div class="line"> </div><div class="line">            <span class="keyword">while</span>(<span class="keyword">my</span> $s = &lt;KID_TO_READ&gt;) &#123; <span class="keyword">print</span> $s; &#125;</div><div class="line">            <span class="keyword">close</span> KID_TO_READ;</div><div class="line">            <span class="keyword">waitpid</span>($pid, <span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">foreach</span> $key ( <span class="keyword">keys</span> %req_params)&#123;</div><div class="line">                       $ENV&#123;$key&#125; = $req_params&#123;$key&#125;;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment"># cd to the script's local directory</span></div><div class="line">                    <span class="keyword">if</span> ($req_params<span class="string">&#123;SCRIPT_FILENAME&#125;</span> =~ <span class="regexp">/^(.*)\/[^\/]+$/</span>) &#123;</div><div class="line">                            <span class="keyword">chdir</span> $1;</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">            <span class="keyword">close</span>(PARENT_WR);</div><div class="line">            <span class="keyword">close</span>(STDIN);</div><div class="line">            <span class="comment">#fcntl(CHILD_RD, F_DUPFD, 0);</span></div><div class="line">            <span class="keyword">syscall</span>(&amp;SYS_dup2, fileno(CHILD_RD), <span class="number">0</span>);</div><div class="line">            <span class="comment">#open(STDIN, "&lt;&amp;CHILD_RD");</span></div><div class="line">            <span class="keyword">exec</span>($req_params<span class="string">&#123;SCRIPT_FILENAME&#125;</span>);</div><div class="line">            <span class="keyword">die</span>(<span class="string">"exec failed"</span>);</div><div class="line">        &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">print</span>(<span class="string">"Content-type: text/plain\r\n\r\n"</span>);</div><div class="line">                <span class="keyword">print</span> <span class="string">"Error: No such CGI app - $req_params&#123;SCRIPT_FILENAME&#125; may not "</span>;</div><div class="line">                <span class="keyword">print</span> <span class="string">"exist or is not executable by this process.\n"</span>;</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>权限分配</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chmod a+x /usr/bin/fastcgi-wrapper.pl</div><div class="line">chmod a+x /etc/rc.d/init.d/perl-fastcgi</div></pre></td></tr></table></figure>
</li>
<li><p>配置nginx 虚拟服务器</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#基本版本配置 /etc/nginx/conf.d/nagios.conf</span></div><div class="line"><span class="section">server</span> &#123;</div><div class="line"> </div><div class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">        <span class="attribute">server_name</span>  localhost;</div><div class="line">        <span class="comment">#access_log  /data/logs/nginx/test.ttlsa.com.access.log  main;</span></div><div class="line"> </div><div class="line">        <span class="attribute">index</span> index.html index.php index.html;</div><div class="line">        <span class="attribute">root</span>	/usr/local/nagios/share;</div><div class="line"> </div><div class="line">        <span class="attribute">location</span> / </div><div class="line">        &#123;</div><div class="line"> </div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="attribute">location</span> <span class="regexp">~ \.pl$</span> </div><div class="line">        &#123;</div><div class="line">            <span class="attribute">include</span>       fastcgi_params;</div><div class="line">            <span class="attribute">fastcgi_pass</span>  <span class="number">127.0.0.1:8999</span>;</div><div class="line">            <span class="comment">#fastcgi_pass  unix:/var/run/ttlsa.com.perl.sock;</span></div><div class="line">            <span class="attribute">fastcgi_index</span> index.pl;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##如果想把tcp/ip方式改为socket方式，可以修改fastcgi-wrapper.pl.</p>
<h2 id="socket-FCGI-OpenSocket-“127-0-0-1-8999”-10-use-IP-sockets"><a href="#socket-FCGI-OpenSocket-“127-0-0-1-8999”-10-use-IP-sockets" class="headerlink" title="$socket = FCGI::OpenSocket( “127.0.0.1:8999”, 10 ); #use IP sockets"></a>$socket = FCGI::OpenSocket( “127.0.0.1:8999”, 10 ); #use IP sockets</h2><h2 id="改为"><a href="#改为" class="headerlink" title="改为"></a>改为</h2><h2 id="socket-FCGI-OpenSocket-“-var-run-ttlsa-com-perl-sock”-10-use-IP-sockets"><a href="#socket-FCGI-OpenSocket-“-var-run-ttlsa-com-perl-sock”-10-use-IP-sockets" class="headerlink" title="$socket = FCGI::OpenSocket( “/var/run/ttlsa.com.perl.sock”, 10 ); #use IP sockets"></a>$socket = FCGI::OpenSocket( “/var/run/ttlsa.com.perl.sock”, 10 ); #use IP sockets</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">7. 启动nginx与fastcgi</div><div class="line"></div><div class="line">   ```shell</div><div class="line">   #重新加载nginx配置</div><div class="line">   nginx -s reload</div><div class="line">   #启动Nginx</div><div class="line">   /etc/init.d/perl-fastcgi start</div></pre></td></tr></table></figure>
</li>
<li><p>fastcgi 测试</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">文件路径/data/site/test.ttlsa.com/test.pl</div><div class="line"><span class="comment">#!/usr/bin/perl</span></div><div class="line"> </div><div class="line"><span class="keyword">print</span> <span class="string">"Content-type:text/html\n\n"</span>;</div><div class="line"><span class="keyword">print</span> &lt;&lt;EndOfHTML;</div><div class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Perl Environment Variables&lt;<span class="regexp">/title&gt;&lt;/head</span>&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;h1&gt;Perl Environment Variables&lt;<span class="regexp">/h1&gt;</span></div><div class="line">EndOfHTML</div><div class="line"> </div><div class="line">foreach $key (sort(keys %ENV)) &#123;</div><div class="line">    print "$key = $ENV&#123;$key&#125;&lt;br&gt;\n";</div><div class="line">&#125;</div><div class="line"> </div><div class="line">print "&lt;/body&gt;&lt;<span class="regexp">/html&gt;";</span></div></pre></td></tr></table></figure>
</li>
<li><p>访问测试</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">http://http:test.ttlsa.com/test.pl,出现内容表示OK.</span></div></pre></td></tr></table></figure>
</li>
<li><p>访问验证</p>
<p><a href="http://htpasswd.net" target="_blank" rel="external">在线htpasswd生成器</a></p>
<p>进入生成网站，进行密码生成</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">user nagios</div><div class="line">password 123456</div><div class="line"></div><div class="line">crypt 		nagios:33QvMQsjxkn3w  *nix 校验 选这个就好了</div><div class="line">apache md5  nagios:$apr1$AVs0w61Q$JamRT9wWtri/lE3iLWxkd/   windows校验</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>复制加密后的密钥对，存入文件/usr/local/nagios/etc/nagiospasswd 保存即可</div><div class="line">crypt 		nagios:33QvMQsjxkn3w</div></pre></td></tr></table></figure>
<p>配置nginx 权限访问</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##完整版本配置 /etc/nginx/conf.d/nagios.conf</span></div><div class="line"><span class="section">server</span> &#123;</div><div class="line">      <span class="attribute">listen</span>	<span class="number">80</span>;</div><div class="line">      <span class="attribute">server_name</span>	localhost;</div><div class="line">      <span class="attribute">index</span>	index.html index.htm index.php;</div><div class="line">      <span class="attribute">root</span>	/usr/local/nagios/share;</div><div class="line">      <span class="attribute">auth_basic</span>	<span class="string">"Nagios Access"</span>;</div><div class="line">      <span class="attribute">auth_basic_user_file</span> /usr/local/nagios/etc/nagiospasswd;     </div><div class="line"></div><div class="line">      <span class="attribute">location</span> <span class="regexp">~ .*\.php?$</span> &#123;</div><div class="line">      <span class="comment">#fastcgi_pass		unix:/tmp/php-cgi.sock;</span></div><div class="line">      <span class="attribute">fastcgi_pass</span>		<span class="number">127.0.0.1:9000</span>;</div><div class="line">      <span class="attribute">fastcgi_index</span>  	index.php;</div><div class="line">      <span class="attribute">include</span>	       	fastcgi.conf;</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<pre><code>location ~ .*\.(cgi|pl)?$ {
gzip            off;
root            /usr/local/nagios/sbin;
rewrite            ^/nagios/cgibin/(.*)\.cgi /$1.cgi break;
fastcgi_pass        127.0.0.1:8999;
fastcgi_param        SCRIPT_FILENAME    /usr/local/nagios/sbin$fastcgi_script_name;
fastcgi_index        index.cgi;
fastcgi_read_timeout    60;
fastcgi_param        REMOTE_USER    $remote_user;
include            fastcgi.conf;
auth_basic        &quot;Nagios Access&quot;;
auth_basic_user_file    /usr/local/nagios/etc/nagiospasswd;
}

location /nagios {
alias             /usr/local/nagios/share;
auth_basic          &quot;Nagios Access&quot;;
auth_basic_user_file     /usr/local/nagios/etc/nagiospasswd;
}
</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">    </div><div class="line">重启加载nginx配置</div><div class="line">    </div><div class="line">```shell</div><div class="line">nginx -s reload</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<pre><code>​
</code></pre><ul>
<li><p>安装nagios</p>
<ol>
<li><p>依赖安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>检测依赖安装状态</div><div class="line">rpm -q gcc glibc glibc-common gd gd-devel xinetd openssl-devel</div><div class="line"><span class="meta">#</span>安装依赖</div><div class="line">yum install -y gcc glibc glibc-common gd gd-devel xinetd openssl-devel</div></pre></td></tr></table></figure>
</li>
<li><p>创建监控用户，用户组，指定安装目录，权限处理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 新增用户</div><div class="line">useradd -s /sbin/nologin nagios</div><div class="line"><span class="meta">#</span> 创建安装目录</div><div class="line">mkdir /usr/local/nagios</div><div class="line"><span class="meta">#</span> 修改目录归属用户</div><div class="line">chown -R nagios.nagios /usr/local/nagios</div><div class="line"><span class="meta">#</span> 查看nagios 目录的权限</div><div class="line">ll -d /usr/local/nagios/</div></pre></td></tr></table></figure>
</li>
<li><p>下载安装nagios</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">wget https://downloads.sourceforge.net/project/nagios/nagios-4.x/nagios-4.3.4/nagios-4.3.4.tar.gz</div><div class="line">tar zxvf nagios-4.3.4.tar.gz</div><div class="line">cd nagios-4.3.4</div><div class="line"></div><div class="line">./configure --prefix=/usr/local/nagios</div><div class="line">make all</div><div class="line">make install</div><div class="line">make install-init</div><div class="line">make install-commandmode</div><div class="line">make install-config</div><div class="line"><span class="meta"></span></div><div class="line">#检查安装</div><div class="line">chkconfig --add nagios</div><div class="line">chkconfig --level 35 nagios on</div><div class="line">chkconfig --list nagios</div><div class="line"></div><div class="line">ls /usr/local/nagios</div><div class="line">....result....</div><div class="line">bin  etc  include  libexec  sbin  share  var</div></pre></td></tr></table></figure>
</li>
<li><p>下载安装nagios 插件 nagios-plugin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://nagios-plugins.org/download/nagios-plugins-2.2.1.tar.gz</div><div class="line">cd nagios-plugins-1.4.16</div><div class="line">./configure --prefix=/usr/local/nagios</div><div class="line">make &amp;&amp; make install</div><div class="line">cd ..</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>配置nagios</p>
<ol>
<li><p>配置文件</p>
<p>| <strong>文件名或目录名</strong>             | <strong>用途</strong>                                   |<br>| ———————– | —————————————- |<br>| cgi.cfg                 | 控制CGI访问的配置文件                             |<br>| nagios.cfg              | Nagios 主配置文件                             |<br>| resource.cfg            | 变量定义文件，又称为资源文件，在些文件中定义变量，以便由其他配置文件引用，如$USER1$ |<br>| objects                 | objects 是一个目录，在此目录下有很多配置文件模板，用于定义Nagios 对象 |<br>| objects/commands.cfg    | 命令定义配置文件，其中定义的命令可以被其他配置文件引用              |<br>| objects/contacts.cfg    | 定义联系人和联系人组的配置文件                          |<br>| objects/localhost.cfg   | 定义监控本地主机的配置文件                            |<br>| objects/printer.cfg     | 定义监控打印机的一个配置文件模板，默认没有启用此文件               |<br>| objects/switch.cfg      | 定义监控路由器的一个配置文件模板，默认没有启用此文件               |<br>| objects/templates.cfg   | 定义主机和服务的一个模板配置文件，可以在其他配置文件中引用            |<br>| objects/timeperiods.cfg | 定义Nagios 监控时间段的配置文件                      |<br>| objects/windows.cfg     | 监控Windows 主机的一个配置文件模板，默认没有启用此文件          |</p>
</li>
<li><p>配置文件之间的关系</p>
<p>在nagios的配置过程中涉及到的几个定义有：主机、主机组，服务、服务组，联系人、联系人组，监控时间，监控命令等，从这些定义可以看出，nagios各个配置文件之间是互为关联，彼此引用的。</p>
<p>成功配置出一台nagios监控系统，必须要弄清楚每个配置文件之间依赖与被依赖的关系，最重要的有四点：</p>
<ul>
<li>定义监控哪些主机、主机组、服务和服务组； </li>
<li>定义这个监控要用什么命令实现； </li>
<li>定义监控的时间段； </li>
<li>定义主机或服务出现问题时要通知的联系人和联系人组。</li>
</ul>
</li>
<li><p>配置Nagios</p>
<p> 为了能更清楚的说明问题，同时也为了维护方便，建议将nagios各个定义对象创建独立的配置文件：</p>
<ul>
<li>创建hosts.cfg文件来定义主机和主机组</li>
<li>创建services.cfg文件来定义服务</li>
<li>用默认的contacts.cfg文件来定义联系人和联系人组</li>
<li>用默认的commands.cfg文件来定义命令</li>
<li>用默认的timeperiods.cfg来定义监控时间段</li>
<li>用默认的templates.cfg文件作为资源引用文件</li>
</ul>
</li>
<li><p>配置文件详解</p>
<p>templates.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">define contact&#123;</div><div class="line">        name                            generic-contact    ; 联系人名称</div><div class="line">        service_notification_period     24x7               ; 当服务出现异常时，发送通知的时间段，这个时间段&quot;24x7&quot;在timeperiods.cfg文件中定义</div><div class="line">        host_notification_period        24x7               ; 当主机出现异常时，发送通知的时间段，这个时间段&quot;24x7&quot;在timeperiods.cfg文件中定义</div><div class="line">        service_notification_options    w,u,c,r            ; 这个定义的是“通知可以被发出的情况”。w即warn，表示警告状态，u即unknown，表示不明状态;</div><div class="line">                                                           ; c即criticle，表示紧急状态，r即recover，表示恢复状态;</div><div class="line">                                                           ; 也就是在服务出现警告状态、未知状态、紧急状态和重新恢复状态时都发送通知给使用者。</div><div class="line">        host_notification_options       d,u,r                   ; 定义主机在什么状态下需要发送通知给使用者，d即down，表示宕机状态;</div><div class="line">                                                                ; u即unreachable，表示不可到达状态，r即recovery，表示重新恢复状态。</div><div class="line">        service_notification_commands   notify-service-by-email ; 服务故障时，发送通知的方式，可以是邮件和短信，这里发送的方式是邮件;</div><div class="line">                                                                ; 其中“notify-service-by-email”在commands.cfg文件中定义。</div><div class="line">        host_notification_commands      notify-host-by-email    ; 主机故障时，发送通知的方式，可以是邮件和短信，这里发送的方式是邮件;</div><div class="line">                                                                ; 其中“notify-host-by-email”在commands.cfg文件中定义。 </div><div class="line">        register                        0                    ; DONT REGISTER THIS DEFINITION - ITS NOT A REAL CONTACT, JUST A TEMPLATE!</div><div class="line">        &#125;</div><div class="line">define host&#123;</div><div class="line">        name                            generic-host    ; 主机名称，这里的主机名，并不是直接对应到真正机器的主机名;</div><div class="line">                                                        ; 乃是对应到在主机配置文件里所设定的主机名。</div><div class="line">        notifications_enabled           1               ; Host notifications are enabled</div><div class="line">        event_handler_enabled           1               ; Host event handler is enabled</div><div class="line">        flap_detection_enabled          1               ; Flap detection is enabled</div><div class="line">        failure_prediction_enabled      1               ; Failure prediction is enabled</div><div class="line">        process_perf_data               1               ; 其值可以为0或1，其作用为是否启用Nagios的数据输出功能;</div><div class="line">                                                        ; 如果将此项赋值为1，那么Nagios就会将收集的数据写入某个文件中，以备提取。</div><div class="line">        retain_status_information       1               ; Retain status information across program restarts</div><div class="line">        retain_nonstatus_information    1               ; Retain non-status information across program restarts</div><div class="line">        notification_period             24x7            ; 指定“发送通知”的时间段，也就是可以在什么时候发送通知给使用者。</div><div class="line">        register                        0               ; DONT REGISTER THIS DEFINITION - ITS NOT A REAL HOST, JUST A TEMPLATE!</div><div class="line">        &#125;</div><div class="line">define host&#123;</div><div class="line">        name                            linux-server    ; 主机名称</div><div class="line">        use                             generic-host    ; use表示引用，也就是将主机generic-host的所有属性引用到linux-server中来;</div><div class="line">                                                        ; 在nagios配置中，很多情况下会用到引用。</div><div class="line">        check_period                    24x7            ; 这里的check_period告诉nagios检查主机的时间段</div><div class="line">        check_interval                  5               ; nagios对主机的检查时间间隔，这里是5分钟。</div><div class="line">        retry_interval                  1               ; 重试检查时间间隔，单位是分钟。</div><div class="line">        max_check_attempts              10              ; nagios对主机的最大检查次数，也就是nagios在检查发现某主机异常时，并不马上判断为异常状况;</div><div class="line">                                                        ; 而是多试几次，因为有可能只是一时网络太拥挤，或是一些其他原因，让主机受到了一点影响;</div><div class="line">                                                        ; 这里的10就是最多试10次的意思。</div><div class="line">        check_command                   check-host-alive ; 指定检查主机状态的命令，其中“check-host-alive”在commands.cfg文件中定义。</div><div class="line">        notification_period             24x7            ; 主机故障时，发送通知的时间范围，其中“workhours”在timeperiods.cfg中进行了定义;</div><div class="line">                                                        ; 下面会陆续讲到。</div><div class="line">        notification_interval           10              ; 在主机出现异常后，故障一直没有解决，nagios再次对使用者发出通知的时间。单位是分钟;</div><div class="line">                                                        ; 如果你觉得，所有的事件只需要一次通知就够了，可以把这里的选项设为0</div><div class="line">        notification_options            d,u,r           ; 定义主机在什么状态下可以发送通知给使用者，d即down，表示宕机状态;</div><div class="line">                                                        ; u即unreachable，表示不可到达状态;</div><div class="line">                                                        ; r即recovery，表示重新恢复状态。</div><div class="line">        contact_groups                  ts              ; 指定联系人组，这个“admins”在contacts.cfg文件中定义。</div><div class="line">        register                        0               ; DONT REGISTER THIS DEFINITION - ITS NOT A REAL HOST, JUST A TEMPLATE!</div><div class="line">        &#125;</div><div class="line">define host&#123;</div><div class="line">        name                    windows-server  ; The name of this host template</div><div class="line">        use                     generic-host    ; Inherit default values from the generic-host template</div><div class="line">        check_period            24x7            ; By default, Windows servers are monitored round the clock</div><div class="line">        check_interval          5               ; Actively check the server every 5 minutes</div><div class="line">        retry_interval          1               ; Schedule host check retries at 1 minute intervals</div><div class="line">        max_check_attempts      10              ; Check each server 10 times (max)</div><div class="line">        check_command           check-host-alive        ; Default command to check if servers are &quot;alive&quot;</div><div class="line">        notification_period     24x7            ; Send notification out at any time - day or night</div><div class="line">        notification_interval   10              ; Resend notifications every 30 minutes</div><div class="line">        notification_options    d,r             ; Only send notifications for specific host states</div><div class="line">        contact_groups          ts              ; Notifications get sent to the admins by default</div><div class="line">        hostgroups              windows-servers ; Host groups that Windows servers should be a member of</div><div class="line">        register                0               ; DONT REGISTER THIS - ITS JUST A TEMPLATE</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        name                            generic-service         ; 定义一个服务名称</div><div class="line">        active_checks_enabled           1                       ; Active service checks are enabled</div><div class="line">        passive_checks_enabled          1                       ; Passive service checks are enabled/accepted</div><div class="line">        parallelize_check               1                       ; Active service checks should be parallelized;</div><div class="line">                                                                ; (disabling this can lead to major performance problems)</div><div class="line">        obsess_over_service             1                       ; We should obsess over this service (if necessary)</div><div class="line">        check_freshness                 0                       ; Default is to NOT check service &apos;freshness&apos;</div><div class="line">        notifications_enabled           1                       ; Service notifications are enabled</div><div class="line">        event_handler_enabled           1                       ; Service event handler is enabled</div><div class="line">        flap_detection_enabled          1                       ; Flap detection is enabled</div><div class="line">        failure_prediction_enabled      1                       ; Failure prediction is enabled</div><div class="line">        process_perf_data               1                       ; Process performance data</div><div class="line">        retain_status_information       1                       ; Retain status information across program restarts</div><div class="line">        retain_nonstatus_information    1                       ; Retain non-status information across program restarts</div><div class="line">        is_volatile                     0                       ; The service is not volatile</div><div class="line">        check_period                    24x7             ; 这里的check_period告诉nagios检查服务的时间段。</div><div class="line">        max_check_attempts              3                ; nagios对服务的最大检查次数。</div><div class="line">        normal_check_interval           5                ; 此选项是用来设置服务检查时间间隔，也就是说，nagios这一次检查和下一次检查之间所隔的时间;</div><div class="line">                                                         ; 这里是5分钟。</div><div class="line">        retry_check_interval            2                ; 重试检查时间间隔，单位是分钟。</div><div class="line">        contact_groups                  ts           ; 指定联系人组</div><div class="line">        notification_options            w,u,c,r          ; 这个定义的是“通知可以被发出的情况”。w即warn，表示警告状态;</div><div class="line">                                                         ; u即unknown，表示不明状态;</div><div class="line">                                                         ; c即criticle，表示紧急状态，r即recover，表示恢复状态;</div><div class="line">                                                         ; 也就是在服务出现警告状态、未知状态、紧急状态和重新恢复后都发送通知给使用者。</div><div class="line">        notification_interval           10               ; Re-notify about service problems every hour</div><div class="line">        notification_period             24x7             ; 指定“发送通知”的时间段，也就是可以在什么时候发送通知给使用者。</div><div class="line">        register                        0                ; DONT REGISTER THIS DEFINITION - ITS NOT A REAL SERVICE, JUST A TEMPLATE!</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        name                            local-service           ; The name of this service template</div><div class="line">        use                             generic-service         ; Inherit default values from the generic-service definition</div><div class="line">        max_check_attempts              4             ; Re-check the service up to 4 times in order to determine its final (hard) state</div><div class="line">        normal_check_interval           5             ; Check the service every 5 minutes under normal conditions</div><div class="line">        retry_check_interval            1             ; Re-check the service every minute until a hard state can be determined</div><div class="line">        register                        0             ; DONT REGISTER THIS DEFINITION - ITS NOT A REAL SERVICE, JUST A TEMPLATE!</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>resource.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$USER1$=/usr/local/nagios/libexec</div></pre></td></tr></table></figure>
<p>commands.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">#notify-host-by-email命令的定义 </div><div class="line">define command&#123;</div><div class="line">        command_name    notify-host-by-email             #命令名称，即定义了一个主机异常时发送邮件的命令。</div><div class="line">        command_line    /usr/bin/printf &quot;%b&quot; &quot;***** Nagios *****\n\nNotification Type: $NOTIFICATIONTYPE$\nHost: $HOSTNAME$\nState: $HOSTSTATE$\nAddress: $HOSTADDRESS$\nInfo: $HOSTOUTPUT$\n\nDate/Time: $LONGDATETIME$\n&quot; | /bin/mail -s &quot;** $NOTIFICATIONTYPE$ Host Alert: $HOSTNAME$ is $HOSTSTATE$ **&quot; $CONTACTEMAIL$                                     #命令具体的执行方式。</div><div class="line">        &#125;</div><div class="line">#notify-service-by-email命令的定义 </div><div class="line">define command&#123;</div><div class="line">        command_name    notify-service-by-email          #命令名称，即定义了一个服务异常时发送邮件的命令</div><div class="line">        command_line    /usr/bin/printf &quot;%b&quot; &quot;***** Nagios *****\n\nNotification Type: $NOTIFICATIONTYPE$\n\nService: $SERVICEDESC$\nHost: $HOSTALIAS$\nAddress: $HOSTADDRESS$\nState: $SERVICESTATE$\n\nDate/Time: $LONGDATETIME$\n\nAdditional Info:\n\n$SERVICEOUTPUT$\n&quot; | /bin/mail -s &quot;** $NOTIFICATIONTYPE$ Service Alert: $HOSTALIAS$/$SERVICEDESC$ is $SERVICESTATE$ **&quot; $CONTACTEMAIL$</div><div class="line">        &#125;</div><div class="line">#check-host-alive命令的定义</div><div class="line">define command&#123;</div><div class="line">        command_name    check-host-alive                 #命令名称，用来检测主机状态。</div><div class="line">        command_line    $USER1$/check_ping -H $HOSTADDRESS$ -w 3000.0,80% -c 5000.0,100% -p 5             </div><div class="line">                        # 这里的变量$USER1$在resource.cfg文件中进行定义，即$USER1$=/usr/local/nagios/libexec;</div><div class="line">                        # 那么check_ping的完整路径为/usr/local/nagios/libexec/check_ping;</div><div class="line">                        # “-w 3000.0,80%”中“-w”说明后面的一对值对应的是“WARNING”状态，“80%”是其临界值。</div><div class="line">                        # “-c 5000.0,100%”中“-c”说明后面的一对值对应的是“CRITICAL”，“100%”是其临界值。</div><div class="line">                        # “-p 1”说明每次探测发送一个包。</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_local_disk</div><div class="line">        command_line    $USER1$/check_disk -w $ARG1$ -c $ARG2$ -p $ARG3$            #$ARG1$是指在调用这个命令的时候，命令后面的第一个参数。</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_local_load</div><div class="line">        command_line    $USER1$/check_load -w $ARG1$ -c $ARG2$</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_local_procs</div><div class="line">        command_line    $USER1$/check_procs -w $ARG1$ -c $ARG2$ -s $ARG3$</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_local_users</div><div class="line">        command_line    $USER1$/check_users -w $ARG1$ -c $ARG2$</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_local_swap</div><div class="line">        command_line    $USER1$/check_swap -w $ARG1$ -c $ARG2$</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_ftp</div><div class="line">        command_line    $USER1$/check_ftp -H $HOSTADDRESS$ $ARG1$</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_http</div><div class="line">        command_line    $USER1$/check_http -I $HOSTADDRESS$ $ARG1$</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_ssh</div><div class="line">        command_line    $USER1$/check_ssh $ARG1$ $HOSTADDRESS$</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_ping</div><div class="line">        command_line    $USER1$/check_ping -H $HOSTADDRESS$ -w $ARG1$ -c $ARG2$ -p 5</div><div class="line">        &#125;</div><div class="line">define command&#123;</div><div class="line">        command_name    check_nt</div><div class="line">        command_line    $USER1$/check_nt -H $HOSTADDRESS$ -p 12489 -v $ARG1$ $ARG2$</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>localhost.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">define host&#123;</div><div class="line">        use                     linux-server            ; Name of host template to use</div><div class="line">                                                        ; This host definition will inherit all variables that are defined</div><div class="line">                                                        ; in (or inherited by) the linux-server host template definition.</div><div class="line">        host_name               Nagios-Server</div><div class="line">        alias                   Nagios-Server</div><div class="line">        address                 127.0.0.1</div><div class="line">        &#125;</div><div class="line">define hostgroup&#123;</div><div class="line">        hostgroup_name  linux-servers ; The name of the hostgroup</div><div class="line">        alias           Linux Servers ; Long name of the group</div><div class="line">        members         Nagios-Server ; Comma separated list of hosts that belong to this group</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                             local-service         ; Name of service template to use</div><div class="line">        host_name                       Nagios-Server</div><div class="line">        service_description             PING</div><div class="line">        check_command                   check_ping!100.0,20%!500.0,60%</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                             local-service         ; Name of service template to use</div><div class="line">        host_name                       Nagios-Server</div><div class="line">        service_description             Root Partition</div><div class="line">        check_command                   check_local_disk!20%!10%!/</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                             local-service         ; Name of service template to use</div><div class="line">        host_name                       Nagios-Server</div><div class="line">        service_description             Current Users</div><div class="line">        check_command                   check_local_users!20!50</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                             local-service         ; Name of service template to use</div><div class="line">        host_name                       Nagios-Server</div><div class="line">        service_description             Total Processes</div><div class="line">        check_command                   check_local_procs!250!400!RSZDT</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                             local-service         ; Name of service template to use</div><div class="line">        host_name                       Nagios-Server</div><div class="line">        service_description             Current Load</div><div class="line">        check_command                   check_local_load!5.0,4.0,3.0!10.0,6.0,4.0</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                             local-service         ; Name of service template to use</div><div class="line">        host_name                       Nagios-Server</div><div class="line">        service_description             Swap Usage</div><div class="line">        check_command                   check_local_swap!20!10</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                             local-service         ; Name of service template to use</div><div class="line">        host_name                       Nagios-Server</div><div class="line">        service_description             SSH</div><div class="line">        check_command                   check_ssh</div><div class="line">        notifications_enabled           0</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                             local-service         ; Name of service template to use</div><div class="line">        host_name                       Nagios-Server</div><div class="line">        service_description             HTTP</div><div class="line">        check_command                   check_http</div><div class="line">        notifications_enabled           0</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>windows.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">define host&#123;</div><div class="line">        use             windows-server  ; Inherit default values from a template</div><div class="line">        host_name       Nagios-Windows  ; The name we&apos;re giving to this host</div><div class="line">        alias           My Windows Server       ; A longer name associated with the host</div><div class="line">        address         192.168.1.113   ; IP address of the host</div><div class="line">        &#125;</div><div class="line">define hostgroup&#123;</div><div class="line">        hostgroup_name  windows-servers ; The name of the hostgroup</div><div class="line">        alias           Windows Servers ; Long name of the group</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               Nagios-Windows</div><div class="line">        service_description     NSClient++ Version</div><div class="line">        check_command           check_nt!CLIENTVERSION</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               Nagios-Windows</div><div class="line">        service_description     Uptime</div><div class="line">        check_command           check_nt!UPTIME</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               Nagios-Windows</div><div class="line">        service_description     CPU Load</div><div class="line">        check_command           check_nt!CPULOAD!-l 5,80,90</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               Nagios-Windows</div><div class="line">        service_description     Memory Usage</div><div class="line">        check_command           check_nt!MEMUSE!-w 80 -c 90</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               Nagios-Windows</div><div class="line">        service_description     C:\ Drive Space</div><div class="line">        check_command           check_nt!USEDDISKSPACE!-l c -w 80 -c 90</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               Nagios-Windows</div><div class="line">        service_description     W3SVC</div><div class="line">        check_command           check_nt!SERVICESTATE!-d SHOWALL -l W3SVC</div><div class="line">        &#125;</div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               Nagios-Windows</div><div class="line">        service_description     Explorer</div><div class="line">        check_command           check_nt!PROCSTATE!-d SHOWALL -l Explorer.exe</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p> cgi.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">default_user_name=david</div><div class="line">authorized_for_system_information=nagiosadmin,david  </div><div class="line">authorized_for_configuration_information=nagiosadmin,david  </div><div class="line">authorized_for_system_commands=david</div><div class="line">authorized_for_all_services=nagiosadmin,david  </div><div class="line">authorized_for_all_hosts=nagiosadmin,david</div><div class="line">authorized_for_all_service_commands=nagiosadmin,david  </div><div class="line">authorized_for_all_host_commands=nagiosadmin,david</div></pre></td></tr></table></figure>
<p>nagios.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">log_file=/usr/local/nagios/var/nagios.log                  # 定义nagios日志文件的路径</div><div class="line">cfg_file=/usr/local/nagios/etc/objects/commands.cfg        # “cfg_file”变量用来引用对象配置文件，如果有更多的对象配置文件，在这里依次添加即可。</div><div class="line">cfg_file=/usr/local/nagios/etc/objects/contacts.cfg</div><div class="line">cfg_file=/usr/local/nagios/etc/objects/hosts.cfg</div><div class="line">cfg_file=/usr/local/nagios/etc/objects/services.cfg</div><div class="line">cfg_file=/usr/local/nagios/etc/objects/timeperiods.cfg</div><div class="line">cfg_file=/usr/local/nagios/etc/objects/templates.cfg</div><div class="line">cfg_file=/usr/local/nagios/etc/objects/localhost.cfg       # 本机配置文件</div><div class="line">cfg_file=/usr/local/nagios/etc/objects/windows.cfg         # windows 主机配置文件</div><div class="line">object_cache_file=/usr/local/nagios/var/objects.cache      # 该变量用于指定一个“所有对象配置文件”的副本文件，或者叫对象缓冲文件</div><div class="line">precached_object_file=/usr/local/nagios/var/objects.precache</div><div class="line">resource_file=/usr/local/nagios/etc/resource.cfg           # 该变量用于指定nagios资源文件的路径，可以在nagios.cfg中定义多个资源文件。</div><div class="line">status_file=/usr/local/nagios/var/status.dat               # 该变量用于定义一个状态文件，此文件用于保存nagios的当前状态、注释和宕机信息等。</div><div class="line">status_update_interval=10                                  # 该变量用于定义状态文件（即status.dat）的更新时间间隔，单位是秒，最小更新间隔是1秒。</div><div class="line">nagios_user=nagios                                         # 该变量指定了Nagios进程使用哪个用户运行。</div><div class="line">nagios_group=nagios                                        # 该变量用于指定Nagios使用哪个用户组运行。</div><div class="line">check_external_commands=1                                  # 该变量用于设置是否允许nagios在web监控界面运行cgi命令;</div><div class="line">                                                           # 也就是是否允许nagios在web界面下执行重启nagios、停止主机/服务检查等操作;</div><div class="line">                                                           # “1”为运行，“0”为不允许。</div><div class="line">command_check_interval=10s                                 # 该变量用于设置nagios对外部命令检测的时间间隔，如果指定了一个数字加一个&quot;s&quot;(如10s);</div><div class="line">                                                           # 那么外部检测命令的间隔是这个数值以秒为单位的时间间隔;</div><div class="line">                                                           # 如果没有用&quot;s&quot;，那么外部检测命令的间隔是以这个数值的“时间单位”的时间间隔。</div><div class="line">interval_length=60                                         # 该变量指定了nagios的时间单位，默认值是60秒，也就是1分钟;</div><div class="line">                                                           # 即在nagios配置中所有的时间单位都是分钟。</div></pre></td></tr></table></figure>
<p>​</p>
<p>timeperiods.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">#下面是定义一个名为24x7的时间段，即监控所有时间段  </div><div class="line">define timeperiod&#123;  </div><div class="line">        timeperiod_name 24x7       #时间段的名称,这个地方不要有空格</div><div class="line">        alias           24 Hours A Day, 7 Days A Week  </div><div class="line">        sunday          00:00-24:00  </div><div class="line">        monday          00:00-24:00  </div><div class="line">        tuesday         00:00-24:00  </div><div class="line">        wednesday       00:00-24:00  </div><div class="line">        thursday        00:00-24:00  </div><div class="line">        friday          00:00-24:00  </div><div class="line">        saturday        00:00-24:00  </div><div class="line">        &#125;  </div><div class="line">#下面是定义一个名为workhours的时间段，即工作时间段。  </div><div class="line">define timeperiod&#123;  </div><div class="line">        timeperiod_name workhours   </div><div class="line">        alias           Normal Work Hours  </div><div class="line">        monday          09:00-17:00  </div><div class="line">        tuesday         09:00-17:00  </div><div class="line">        wednesday       09:00-17:00  </div><div class="line">        thursday        09:00-17:00  </div><div class="line">        friday          09:00-17:00  </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>​</p>
<p>host.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">define host&#123;   </div><div class="line">        use                     linux-server          #引用主机linux-server的属性信息，linux-server主机在templates.cfg文件中进行了定义。</div><div class="line">        host_name               Nagios-Linux          #主机名</div><div class="line">        alias                   Nagios-Linux          #主机别名</div><div class="line">        address                 192.168.1.111         #被监控的主机地址，这个地址可以是ip，也可以是域名。</div><div class="line">        &#125;   </div><div class="line">#定义一个主机组   </div><div class="line">define hostgroup&#123;      </div><div class="line">        hostgroup_name          bsmart-servers        #主机组名称，可以随意指定。</div><div class="line">        alias                   bsmart servers        #主机组别名</div><div class="line">        members                 Nagios-Linux          #主机组成员，其中“Nagios-Linux”就是上面定义的主机。     </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p> services.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">define service&#123;  </div><div class="line">        use                     local-service          #引用local-service服务的属性值，local-service在templates.cfg文件中进行了定义。</div><div class="line">        host_name               Nagios-Linux           #指定要监控哪个主机上的服务，“Nagios-Server”在hosts.cfg文件中进行了定义。</div><div class="line">        service_description     check-host-alive       #对监控服务内容的描述，以供维护人员参考。</div><div class="line">        check_command           check-host-alive       #指定检查的命令。</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p> contacts.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">define contact&#123;</div><div class="line">        contact_name                    David             #联系人的名称,这个地方不要有空格</div><div class="line">        use                             generic-contact   #引用generic-contact的属性信息，其中“generic-contact”在templates.cfg文件中进行定义</div><div class="line">        alias                           Nagios Admin</div><div class="line">        email                           david.tang@bsmart.cn</div><div class="line">        &#125;</div><div class="line"></div><div class="line">define contactgroup&#123;</div><div class="line">        contactgroup_name       ts                              #联系人组的名称,同样不能空格</div><div class="line">        alias                   Technical Support               #联系人组描述</div><div class="line">        members                 David                           #联系人组成员，其中“david”就是上面定义的联系人，如果有多个联系人则以逗号相隔</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>验证配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>新增从机监控</p>
<ol>
<li><p>安装nrpe</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tar zxvf nrpe-2.13.tar.gz</div><div class="line">cd nrpe-2.13</div><div class="line">./configure</div><div class="line"></div><div class="line">make all</div><div class="line"><span class="meta"></span></div><div class="line"># 安装check_nrpe </div><div class="line">make install-plugin</div></pre></td></tr></table></figure>
</li>
<li><p>测试连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/usr/local/nagios/libexec/check_nrpe -H 192.192.192.192 被监控机IP</div><div class="line">....result....</div><div class="line">NRPE v2.13</div></pre></td></tr></table></figure>
</li>
<li><p>在commands.cfg中增加对check_nrpe的定义</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/nagios/etc/objects/commands.cfg</div><div class="line"><span class="meta"></span></div><div class="line"># 'check_nrpe' command definition</div><div class="line">define command&#123;</div><div class="line">        command_name    check_nrpe         # 定义命令名称为check_nrpe,在services.cfg中要使用这个名称.</div><div class="line">        command_line    $USER1$/check_nrpe -H $HOSTADDRESS$ -c $ARG1$       #这是定义实际运行的插件程序.</div><div class="line">                        # 这个命令行的书写要完全按照check_nrpe这个命令的用法,不知道用法的就用check_nrpe –h查看.</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>定义监控 services.cfg </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">define service&#123;</div><div class="line">        use                     local-service</div><div class="line">        host_name               Nagios-Linux</div><div class="line">        service_description     Current Load</div><div class="line">        check_command           check_nrpe!check_load</div><div class="line">        &#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use                     local-service</div><div class="line">        host_name               Nagios-Linux</div><div class="line">        service_description     Check Disk sda1</div><div class="line">        check_command           check_nrpe!check_sda1</div><div class="line">        &#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use                     local-service</div><div class="line">        host_name               Nagios-Linux</div><div class="line">        service_description     Total Processes</div><div class="line">        check_command           check_nrpe!check_total_procs</div><div class="line">        &#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use                     local-service</div><div class="line">        host_name               Nagios-Linux</div><div class="line">        service_description     Current Users</div><div class="line">        check_command           check_nrpe!check_users</div><div class="line">        &#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use                     local-service</div><div class="line">        host_name               Nagios-Linux</div><div class="line">        service_description     Check Zombie Procs</div><div class="line">        check_command           check_nrpe!check_zombie_procs</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>添加未定义监控</p>
<p>现在我们要监控swap 分区，如果空闲空间小于20%则为警告状态 -&gt; warning；如果小于10%则为严重状态 -&gt; critical。我们可以查得需要使用check_swap插件，完整的命令行应该是下面这样。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nagios/libexec/check_swap -w 20% -c 10%</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">在**被监控机**（Nagios-Linux）上增加check_swap 命令的定义</div><div class="line"></div><div class="line">```shell</div><div class="line">vi /usr/local/nagios/etc/nrpe.cfg</div><div class="line">    </div><div class="line"># 增加下面这一行</div><div class="line">    </div><div class="line">command[check_swap]=/usr/local/nagios/libexec/check_swap -w 20% -c 10%</div><div class="line">    </div><div class="line"># 监控 http</div><div class="line">command[check_http]=/usr/local/nagios/libexec/check_http -I 127.0.0.1</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<pre><code>在 **监控机**（Nagios-Server）上增加这个check_swap 监控项目

<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">define service&#123;</div><div class="line">        use                     local-service</div><div class="line">        host_name               Nagios-Linux</div><div class="line">        service_description     Check Swap</div><div class="line">        check_command           check_nrpe!check_swap</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">define service&#123;</div><div class="line">        use                     local-service</div><div class="line">        host_name               Nagios-Linux</div><div class="line">        service_description     HTTP</div><div class="line">        check_command           check_nrpe!check_http</div><div class="line">        &#125;</div></pre></td></tr></table></figure>


 **重启nagios服务**

​
</code></pre><ul>
<li><p>Nagios启动与停止</p>
<ol>
<li>启动Nagios</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> /etc/init.d/nagios start</div><div class="line">or</div><div class="line"><span class="meta">#</span> service nagios start</div><div class="line">or</div><div class="line">/usr/local/nagios/bin/nagios -d /usr/local/nagios/etc/nagios.cfg</div></pre></td></tr></table></figure>
<ol>
<li>重启Nagios</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> /etc/init.d/nagios reload</div><div class="line">or</div><div class="line"><span class="meta">#</span> /etc/init.d/nagios restart</div><div class="line">or</div><div class="line"><span class="meta">#</span> service nagios restart</div><div class="line"><span class="meta"></span></div><div class="line">#  通过web监控页重启nagios</div><div class="line">Process Info -&gt; Restart the Nagios process</div><div class="line"><span class="meta"></span></div><div class="line"># 手工方式平滑重启</div><div class="line">ps aux|grep nagios</div><div class="line">or</div><div class="line">ps -ef|grep nagios</div><div class="line"></div><div class="line">kill -HUP &lt;nagios_pid&gt;</div></pre></td></tr></table></figure>
<ol>
<li>停止Nagios</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> /etc/init.d/nagios stop</div><div class="line">or</div><div class="line"><span class="meta">#</span> service nagios stop</div><div class="line"><span class="meta"></span></div><div class="line"># 通过web监控页停止nagios</div><div class="line">Process Info -&gt; Shutdown the Nagios process</div><div class="line"><span class="meta"></span></div><div class="line"># 手工方式停止Nagios</div><div class="line">ps aux|grep nagios</div><div class="line">or</div><div class="line">ps -ef|grep nagios</div><div class="line"></div><div class="line">kill &lt;nagios_pid&gt;</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<p>##被监控机安装依赖</p>
<ul>
<li><p>依赖安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>检测依赖安装状态</div><div class="line">rpm -q gcc glibc glibc-common gd gd-devel xinetd openssl-devel</div><div class="line"><span class="meta">#</span>安装依赖</div><div class="line">yum install -y gcc glibc glibc-common gd gd-devel xinetd openssl-devel</div></pre></td></tr></table></figure>
</li>
<li><p>创建监控用户，用户组，指定安装目录，权限处理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 新增用户</div><div class="line">useradd -s /sbin/nologin nagios</div><div class="line"><span class="meta">#</span> 创建安装目录</div><div class="line">mkdir /usr/local/nagios</div><div class="line"><span class="meta">#</span> 修改目录归属用户</div><div class="line">chown -R nagios.nagios /usr/local/nagios</div><div class="line"><span class="meta">#</span> 查看nagios 目录的权限</div><div class="line">ll -d /usr/local/nagios/</div></pre></td></tr></table></figure>
</li>
<li><p>下载必备软件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 下载nagios-plugin</div><div class="line">wget https://nagios-plugins.org/download/nagios-plugins-2.2.1.tar.gz</div><div class="line"><span class="meta">#</span> 下载nrpe</div><div class="line">wget http://prdownloads.sourceforge.net/sourceforge/nagios/nrpe-2.13.tar.gz</div></pre></td></tr></table></figure>
</li>
<li><p>安装nagios-plugin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 编译安装</div><div class="line">tar zxvf nagios-plugins-2.2.1.tar.gz</div><div class="line">cd nagios-plugins-1.4.16</div><div class="line">./configure --prefix=/usr/local/nagios</div><div class="line">make &amp;&amp; make install</div><div class="line">cd ..</div><div class="line"><span class="meta"></span></div><div class="line"># 修改权限</div><div class="line">chown nagios.nagios /usr/local/nagios</div><div class="line">chown -R nagios.nagios /usr/local/nagios/libexec</div></pre></td></tr></table></figure>
</li>
<li><p>安装NRPE</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">tar zxvf nrpe-2.13.tar.gz</div><div class="line">cd nrpe-2.13</div><div class="line">./configure</div><div class="line"></div><div class="line">make all</div><div class="line"><span class="meta"></span></div><div class="line"># 安装check_nrpe </div><div class="line">make install-plugin</div><div class="line"><span class="meta"></span></div><div class="line"># 安装deamon</div><div class="line">make install-daemon</div><div class="line"><span class="meta"></span></div><div class="line"># 安装配置文件</div><div class="line">make install-daemon-config</div><div class="line"><span class="meta"></span></div><div class="line"># 安装xinted 脚本</div><div class="line">make install-xinetd</div></pre></td></tr></table></figure>
</li>
<li><p>配置NRPE</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /etc/xinetd.d/nrpe</div><div class="line"></div><div class="line">.....before......</div><div class="line">       only_from       = 127.0.0.1</div><div class="line">.....after.......</div><div class="line">       only_from       = 127.0.0.1 监控主机ip 120.120.120.120</div></pre></td></tr></table></figure>
</li>
<li><p>配置网络属性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">vim /etc/services</div><div class="line"></div><div class="line">......before......</div><div class="line">matahari        49000/tcp               # Matahari Broker</div><div class="line">......after......</div><div class="line">matahari        49000/tcp               # Matahari Broker</div><div class="line"><span class="meta">#</span> nagios</div><div class="line">nrpe            5666/tcp                # nrpe</div></pre></td></tr></table></figure>
</li>
<li><p>启动，并查看nrpe是否启动成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 启动</div><div class="line">service xinetd restart</div><div class="line"><span class="meta">#</span> 查看启动</div><div class="line">netstat -an|grep 5666</div><div class="line">....result....</div><div class="line">tcp6       0      0 :::5666                 :::*                    LISTEN </div><div class="line"><span class="meta"></span></div><div class="line"># 测试运行</div><div class="line">/usr/local/nagios/libexec/check_nrpe -H localhost</div><div class="line">....result....</div><div class="line">NRPE v2.13</div><div class="line"><span class="meta"></span></div><div class="line"># check_nrpe 用法</div><div class="line"><span class="meta">#</span> 注意：-c 后面接的监控命令必须是nrpe.cfg 文件中定义的。也就是NRPE daemon只运行nrpe.cfg中所定义的命令。</div><div class="line">check_nrpe –H 被监控的主机 -c 要执行的监控命令</div></pre></td></tr></table></figure>
</li>
<li><p>配置nrpe监控命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/nagios/etc</div><div class="line">cat nrpe.cfg |grep -v "^#"|grep -v "^$"</div><div class="line">....result....</div><div class="line">log_facility=daemon</div><div class="line">pid_file=/var/run/nrpe.pid</div><div class="line">server_port=5666</div><div class="line">nrpe_user=nagios</div><div class="line">nrpe_group=nagios</div><div class="line">allowed_hosts=127.0.0.1</div><div class="line"> </div><div class="line">dont_blame_nrpe=0</div><div class="line">debug=0</div><div class="line">command_timeout=60</div><div class="line">connection_timeout=300</div><div class="line">command[check_users]=/usr/local/nagios/libexec/check_users -w 5 -c 10</div><div class="line">command[check_load]=/usr/local/nagios/libexec/check_load -w 15,10,5 -c 30,25,20</div><div class="line">command[check_sda1]=/usr/local/nagios/libexec/check_disk -w 20% -c 10% -p /dev/sda1</div><div class="line">command[check_zombie_procs]=/usr/local/nagios/libexec/check_procs -w 5 -c 10 -s Z</div><div class="line">command[check_total_procs]=/usr/local/nagios/libexec/check_procs -w 150 -c 200 </div><div class="line">....result....</div><div class="line"><span class="meta"></span></div><div class="line">#新增 command</div><div class="line"><span class="meta">#</span>代理 内容</div></pre></td></tr></table></figure>
</li>
</ul>
<p>##分布式处理</p>
<ul>
<li><p>主Nagios中心服务部署</p>
<ol>
<li><p>安装nsca</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget http://download.chekiang.info/nagios/nsca-2.7.2.tar.gz</div><div class="line">tar zxvf nsca-2.9.1.tar.gz</div><div class="line">cd nsca-2.7.2</div><div class="line">./configure</div><div class="line">make all</div></pre></td></tr></table></figure>
</li>
<li><p>修改nsca的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/nagios/etc/nsca.cfg</div><div class="line"></div><div class="line">password=123456</div></pre></td></tr></table></figure>
</li>
<li><p>修改nagios的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/nagios/etc/nagios.cfg</div><div class="line"></div><div class="line">check_external_commands=1 # 配置nagios检查扩展命令</div><div class="line">accept_passive_service_checks=1 # 配置接受被动服务检测的结果</div><div class="line">accept_passive_host_checks=1 #配置接受被动主机检测的结果</div></pre></td></tr></table></figure>
</li>
<li><p>检查没问题后重启nagios和启动nsca </p>
</li>
</ol>
</li>
<li><p>分布服务器部署</p>
<ol>
<li><p>安装nsca-send</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">wget http://download.chekiang.info/nagios/nsca-2.7.2.tar.gz</div><div class="line">tar zxvf nsca-2.9.1.tar.gz</div><div class="line">cd nsca-2.7.2</div><div class="line">./configure </div><div class="line">make all</div><div class="line"><span class="meta"></span></div><div class="line"># 以上步骤检查正确执行以后会在src目录下生成两个程序 </div><div class="line"><span class="meta">#</span> nsca send_nsca（主程序），sample-config中会有nsca.cfg与send_nsca.cfg（配置文件）。</div></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cp src/send_nsca /usr/local/nagios/bin/</div><div class="line">cp sample-config/send_nsca.cfg /usr/local/nagios/etc/</div><div class="line">chown nagios.nagios /usr/local/nagios/bin/send_nsca</div><div class="line">chown nagios.nagios /usr/local/nagios/etc/send_nsca.cfg</div><div class="line"><span class="meta">#</span> 修改send_nsca.cfg配置，改下密码。</div><div class="line"></div><div class="line">vi /usr/local/nagios/etc/send_nsca.cfg</div><div class="line"><span class="meta">#</span> password=123456</div><div class="line"><span class="meta">#</span> 这里的密码需要和主的一样。</div></pre></td></tr></table></figure>
</li>
<li><p>修改nagios配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">enable_notifications=0 //阻止它直接送出任何通知信息 </div><div class="line">obsess_over_services=1 // 配置为强迫型服务(obsess over services)类型 </div><div class="line">ocsp_command=submit_service_check_result //定义一个强迫型服务处理(ocsp)命令 </div><div class="line">obsess_over_hosts=1 // 配置为强迫型服务(obsess over host)类型 </div><div class="line">ochp_command=submit_host_check_result //定义一个强迫型主机处理(ochp)命令</div></pre></td></tr></table></figure>
</li>
<li><p>添加ocsp命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> vi command.cfg</div><div class="line">define command&#123;</div><div class="line">    command_name submit_service_check_result</div><div class="line">    command_line $USER1$/eventhandlers/submit_service_check_result $HOSTNAME$ '$SERVICEDESC$' $SERVICESTATE$ '$SERVICEOUTPUT$ | $SERVICEPERFDATA$ [$SERVICECHECKCOMMAND$]'</div><div class="line">&#125;</div><div class="line">define command&#123;</div><div class="line">    command_name submit_host_check_result</div><div class="line">    command_line $USER1$/eventhandlers/submit_host_check_result $HOSTNAME$ $HOSTSTATE$ '$HOSTOUTPUT$'</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>添加命令脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir /usr/local/nagios/libexec/eventhandlers</div><div class="line">cd /usr/local/nagios/libexec/eventhandlers</div><div class="line">wget https://raw.githubusercontent.com/zhangnq/nagios/master/setup/submit_host_check_result</div><div class="line">wget https://raw.githubusercontent.com/zhangnq/nagios/master/setup/submit_service_check_result</div><div class="line">chmod +x /usr/local/nagios/libexec/eventhandlers/submit_host_check_result</div><div class="line">chmod +x /usr/local/nagios/libexec/eventhandlers/submit_service_check_result</div><div class="line"><span class="meta">#</span> 修改submit_host_check_result和submit_service_check_result两个脚本中的中心nagios监控主机ip或域名，即修改www.chekiang.info为你自己的地址。</div></pre></td></tr></table></figure>
</li>
<li><p>检查没问题后有启动nagios。</p>
</li>
</ol>
</li>
<li><p>添加监控主机和服务</p>
<ol>
<li><p>注意事项</p>
<ul>
<li>中心服务器和分布服务器都需要添加监控的主机和服务。</li>
<li>中心服务器主机定义的host_name值需要和分布服务器主机定义的host_name值一致。</li>
<li>中心服务器服务定义的service_description值需要和分布服务器服务定义的service_description 值一致。</li>
</ul>
</li>
<li><p>分布服务器配置</p>
<p>分布服务器的配置增加和主动监控一样，先添加host，然后添加server即可。</p>
</li>
<li><p>中心服务器</p>
<ul>
<li><p>增加passive模式的主机和服务模板</p>
<p>修改templates.cfg 文件，增加类似如下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> vi /usr/local/nagios/etc/objects/templates.cfg</div><div class="line">define host&#123;</div><div class="line">        name                            passive-host</div><div class="line">        use                             generic-host</div><div class="line">        check_period                    24x7</div><div class="line">        check_interval                  5</div><div class="line">        retry_interval                  1</div><div class="line">        max_check_attempts              10</div><div class="line">        check_command                   check-host-alive</div><div class="line">        notification_period             24x7</div><div class="line">        notification_interval           60</div><div class="line">        notification_options            d,u,r</div><div class="line">        contact_groups                  sysmaint</div><div class="line">        register                        0</div><div class="line">        check_freshness                 1  ;定义强制刷新检测</div><div class="line">        freshness_threshold             600  ;指定服务检测结果应该在何时间内刷新，单位是s</div><div class="line">        passive_checks_enabled          1  ;打开被动检测</div><div class="line">        active_checks_enabled           0  ;关闭主动监测</div><div class="line">&#125;</div><div class="line">define service&#123;</div><div class="line">        name                            passive-service</div><div class="line">        use                             generic-service</div><div class="line">        active_checks_enabled           0  ;关闭主动监测</div><div class="line">        passive_checks_enabled          1  ;打开被动检测</div><div class="line">        flap_detection_enabled          0  ;关闭状态抖动检测</div><div class="line">        check_freshness                 1  ;定义强制刷新检测</div><div class="line">        freshness_threshold             600  ;指定服务检测结果应该在何时间内刷新，单位是s</div><div class="line">        max_check_attempts              4</div><div class="line">        normal_check_interval           5</div><div class="line">        retry_check_interval            1</div><div class="line">        register                        0</div><div class="line">        check_command                   service-is-stale ;定义强制检测的执行命令</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>增加强制检测命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> vi /usr/local/nagios/libexec/staleservice.sh</div><div class="line"><span class="meta">#</span>!/bin/bash</div><div class="line"></div><div class="line">/bin/echo "CRITICAL: Service results are stale!"</div><div class="line">exit 2</div><div class="line"><span class="meta">#</span> chmod +x /usr/local/nagios/libexec/staleservice.sh</div><div class="line">添加命令</div><div class="line"><span class="meta"></span></div><div class="line"># vi /usr/local/nagios/etc/objects/commands.cfg</div><div class="line">define command&#123;</div><div class="line">        command_name    service-is-stale</div><div class="line">        command_line    $USER1$/staleservice.sh</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>添加主机和服务</p>
<p>复制分布服务器中的hosts和servers到nagios中心服务器中，修改定义主机中的use模板为定义的passive-host，之前默认一般为linux-server，修改定义服务器中的use模板为定义的passive-service，取消check_command值的定义。类似如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">define host&#123;</div><div class="line">        use             passive-host</div><div class="line">        host_name       10.22.127.100</div><div class="line">        alias           10.22.127.100</div><div class="line">        address         10.22.127.100</div><div class="line">&#125;</div><div class="line">define service&#123;</div><div class="line">        use                     passive-service,srv-pnp</div><div class="line">        host_name               10.22.127.100</div><div class="line">        service_description     check ssh login</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>检查重启</p>
<p>添加完成后检查nagios配置是否正确，然后重启。</p>
</li>
<li><p>日志</p>
<p>日志一般是在/usr/local/nagios/var/nagios.log中，正常的话显示如下，如果配置有问题也可以通过日志查找原因。</p>
</li>
</ul>
</li>
</ol>
<p>​</p>
</li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-09-21</span><i class="fa fa-tag"></i><a href="/tags/nagios-服务器监控/" title="nagios 服务器监控" class="tag">nagios 服务器监控 </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2017/09/21/nagios-nginx-分布式安装指南/,Forever Young,nagios+nginx+分布式安装指南,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2017/05/27/Kotlin类与对象/" title="Kotlin类与对象" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>